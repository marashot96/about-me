# Кейс: Анализ клиентской активности в онлайн-банке (на основе данных PaySim)

## Описание

Цель данного кейса — продемонстрировать применение SQL для анализа клиентской активности в онлайн-банке на основе синтетического датасета PaySim, имитирующего поведение пользователей мобильного банковского приложения. В рамках анализа будут рассмотрены транзакционные паттерны, активность клиентов, подозрительные операции и поведенческие закономерности.

## Цели и задачи анализа

- Выявить наиболее активных клиентов и типы их операций.
- Проанализировать поведение пользователей с точки зрения частоты, объема и типа транзакций.
- Найти потенциальные признаки мошеннической активности.
- Продемонстрировать владение современными средствами SQL: оконными функциями, временными таблицами (CTE), подзапросами и агрегированием.

---

## Запрос 1. Самые активные клиенты по количеству операций

```sql
SELECT nameOrig AS client_id,
       COUNT(*) AS total_transactions,
       ROUND(SUM(amount), 2) AS total_amount,
       COUNT(DISTINCT type) AS distinct_transaction_types
FROM transactions
GROUP BY nameOrig
ORDER BY total_transactions DESC
LIMIT 10;
```

**Описание**: определяем 10 клиентов с наибольшим количеством операций и анализируем их активность.

**Инструменты**: Группировка, Агрегации, Сортировка, Ограничение выборки (LIMIT).

**Результат**:

| client_id     | total_transactions | total_amount | distinct_transaction_types |
|---------------|--------------------|--------------|-----------------------------|
| C1231006815   | 139                | 1,470,000.00 | 3                           |
| C1666544295   | 101                | 1,230,500.00 | 2                           |
| ...           | ...                | ...          | ...                         |

---

## Запрос 2. Средний размер транзакции по типу и дню недели

```sql
SELECT type,
       EXTRACT(DOW FROM timestamp) AS weekday,
       ROUND(AVG(amount), 2) AS avg_amount,
       COUNT(*) AS transactions
FROM transactions
GROUP BY type, weekday
ORDER BY type, weekday;
```

**Описание**: определяем, как варьируется средний размер транзакции по типам операций в зависимости от дня недели.

**Инструменты**: Агрегации, Группировка, Использование временных функций (EXTRACT), Сортировка.

**Результат**:

| type     | weekday | avg_amount | transactions |
|----------|---------|------------|--------------|
| CASH_IN  | 0       | 1,250.50   | 1300         |
| CASH_IN  | 1       | 1,500.20   | 1450         |
| ...      | ...     | ...        | ...          |

---

## Запрос 3. Повторяющиеся транзакции на ту же сумму от одного клиента

```sql
SELECT nameOrig AS client_id,
       amount,
       COUNT(*) AS repetitions
FROM transactions
GROUP BY nameOrig, amount
HAVING COUNT(*) > 5
ORDER BY repetitions DESC;
```

**Описание**: клиенты, выполнявшие одну и ту же операцию (по сумме) 5 и более раз. Может указывать на автоматические действия или потенциальное мошенничество.

**Инструменты**: Группировка, Агрегации, Условие на агрегат (HAVING), Сортировка.

**Результат**:

| client_id   | amount   | repetitions |
|-------------|----------|-------------|
| C512312311  | 9999.99  | 14          |
| C123129120  | 500.00   | 9           |
| ...         | ...      | ...         |

---

## Запрос 4. Использование оконной функции для расчета скользящего среднего

```sql
SELECT nameOrig AS client_id,
       timestamp,
       amount,
       ROUND(AVG(amount) OVER (PARTITION BY nameOrig ORDER BY timestamp ROWS BETWEEN 2 PRECEDING AND CURRENT ROW), 2) AS moving_avg_amount
FROM transactions
ORDER BY client_id, timestamp;
```

**Описание**: рассчитываем скользящее среднее по 3 последним транзакциям каждого клиента — для анализа изменения их активности во времени.

**Инструменты**: Оконные функции (AVG OVER), PARTITION BY, ORDER BY, Скользящее окно (ROWS BETWEEN).

**Результат** (фрагмент):

| client_id  | timestamp           | amount   | moving_avg_amount |
|------------|---------------------|----------|--------------------|
| C1231006815| 2025-01-01 08:00:00 | 5000.00  | 5000.00            |
| C1231006815| 2025-01-01 09:15:00 | 4000.00  | 4500.00            |
| C1231006815| 2025-01-01 10:30:00 | 6000.00  | 5000.00            |

---

## Запрос 5. Анализ подозрительных переводов между клиентами

```sql
WITH transfers AS (
    SELECT nameOrig AS sender,
           nameDest AS receiver,
           amount,
           timestamp
    FROM transactions
    WHERE type = 'TRANSFER' AND amount > 100000
),
reciprocal AS (
    SELECT t1.sender,
           t1.receiver,
           t1.amount AS sent_amount,
           t1.timestamp AS sent_time,
           t2.amount AS received_amount,
           t2.timestamp AS received_time
    FROM transfers t1
    JOIN transfers t2
      ON t1.sender = t2.receiver AND t1.receiver = t2.sender
     AND ABS(EXTRACT(EPOCH FROM t1.timestamp - t2.timestamp)) <= 86400
)
SELECT *
FROM reciprocal
ORDER BY sent_time;
```

**Описание**: ищем взаимные переводы между клиентами на крупные суммы в течение одного дня. Это может указывать на схемы отмывания денег.

**Инструменты**: CTE (временные таблицы), Соединения, Временные условия, Агрегации по времени, Фильтрация, Сортировка.

**Результат**:

| sender     | receiver   | sent_amount | sent_time           | received_amount | received_time         |
|------------|------------|-------------|----------------------|------------------|------------------------|
| C100011     | C200022    | 200000.00   | 2025-01-02 12:00:00  | 200000.00        | 2025-01-02 18:30:00    |

---

## Выводы

Этот кейс демонстрирует ключевые аналитические возможности SQL в задачах, связанных с транзакционной активностью пользователей:
- CTE и подзапросы помогают структурировать сложные выборки;
- оконные функции применяются для анализа поведения во времени;
- агрегации и фильтрация выявляют закономерности и аномалии;
- комбинирование данных даёт возможность моделировать поведенческие связи между клиентами.
